<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:EVE_NEIC.App.ViewModels"
        xmlns:models="using:EVE_NEIC.App.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:conv="using:EVE_NEIC.App.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="EVE_NEIC.App.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="New Eden Industrial Companion"

        xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia">

    <Window.Resources>
        <conv:ProfitColorConverter x:Key="ProfitColorConverter"/>
    </Window.Resources>
    
    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <Grid ColumnDefinitions="450, *">
        <!-- Blueprint Selection Panel -->
        <DockPanel Margin="0,0,10,0">
            <!-- Top Area: Status and Progress -->
            <StackPanel DockPanel.Dock="Top" Spacing="5" Margin="0,0,0,10">
                <TextBox Text="{Binding SearchText}"
                         Watermark="Search blueprints..."
                         Margin="0,0,0,5" />
                <TextBlock Text="{Binding StatusText}" FontWeight="Bold" TextWrapping="Wrap" FontSize="12" />
                <ProgressBar Value="{Binding DownloadProgress}"
                             Minimum="0"
                             Maximum="100"
                             IsIndeterminate="False"
                             ShowProgressText="True"
                             Height="16"
                             IsVisible="{Binding IsBusy}" />
            </StackPanel>

            <!-- Bottom Area: Actions -->
            <StackPanel DockPanel.Dock="Bottom" Margin="0,10,0,0">
                <Button Content="Refresh Blueprints from Local SDE"
                        Command="{Binding RefreshBlueprintsCommand}"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"
                        Margin="0,10,0,0" />
            </StackPanel>

            <!-- Center Area: The List -->
            <ScrollViewer>
                <ItemsControl ItemsSource="{Binding GroupedBlueprints}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:BlueprintGroup">
                            <Expander Header="{Binding Name}" IsExpanded="{Binding IsExpanded}"
                                      HorizontalAlignment="Stretch" Margin="0,2">
                                <ListBox ItemsSource="{Binding Blueprints}"
                                         SelectedItem="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectedBlueprint}">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:Blueprint">
                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                <TextBlock Text="{Binding TypeId}" Foreground="Gray" FontSize="10"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Expander>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </DockPanel>

        <!-- RIGHT SIDE: Details Area -->
        <Border Grid.Column="1" Background="#2b2b2b" CornerRadius="5" Padding="20">
            <!-- Only show this if a blueprint is selected -->
            <StackPanel IsVisible="{Binding SelectedBlueprint, Converter={x:Static ObjectConverters.IsNotNull}}">
                <Grid ColumnDefinitions="64, *" RowDefinitions="Auto, Auto">
                    <!-- The Icon -->
                    <Image Grid.Column="0" Grid.RowSpan="2"
                           Width="64" Height="64"
                           Margin="0,0,15,0"
                           asyncImageLoader:ImageLoader.Source="{Binding SelectedBlueprint.IconUrl}" />
                    <!-- The Title -->
                    <TextBlock Grid.Column="1" Grid.Row="0"
                               Text="{Binding SelectedBlueprint.Name}"
                               FontSize="24"
                               FontWeight="Bold"
                               Margin="0,0,0,10" />
                    <!-- The Group Name -->
                    <TextBlock Grid.Column="1" Grid.Row="1"
                               Text="{Binding SelectedBlueprint.GroupName}"
                               Foreground="Gray" FontSize="14"
                               VerticalAlignment="Top" />
                </Grid>

                <Separator Height="1" Background="#33ffffff" Margin="0,10" />

                <TextBlock Text="Description" FontWeight="Bold" Margin="0,10,0,5" />
                <TextBlock Text="{Binding SelectedBlueprint.Description}"
                           TextWrapping="Wrap"
                           Opacity="0.8" />

                <!-- Production Efficiency Section -->
                <StackPanel Spacing="5" Margin="0,15,0,10">
                    <TextBlock Text="Blueprint Research" FontWeight="Bold" FontSize="14" />
                    <!-- ME Slider -->
                    <DockPanel>
                        <TextBlock Text="{Binding SelectedBlueprint.MaterialEfficiency, StringFormat='ME: {0}%'}"
                                   Width="60" VerticalAlignment="Center" />
                        <Slider Minimum="0" Maximum="10"
                                Value="{Binding SelectedBlueprint.MaterialEfficiency}"
                                TickFrequency="1"
                                IsSnapToTickEnabled="True"
                                Margin="10,0,0,0" />
                    </DockPanel>
                    <!-- TE Slider -->
                    <DockPanel>
                        <TextBlock Text="{Binding SelectedBlueprint.TimeEfficiency, StringFormat='TE: {0}%'}"
                                   Width="60" VerticalAlignment="Center"/>
                        <Slider Minimum="0" Maximum="20"
                                Value="{Binding SelectedBlueprint.TimeEfficiency}"
                                TickFrequency="2"
                                IsSnapToTickEnabled="True"
                                Margin="10,0,0,0"/>
                    </DockPanel>
                </StackPanel>
                
                <Separator Height="1" Background="#33ffffff" Margin="0,5,0,15"/>
                
                <TextBlock Text="Manufacturing Materials" FontWeight="Bold" Margin="0,20,0,5" />
                <Border Background="#1a1a1a" CornerRadius="5" Padding="10">
                    <ItemsControl ItemsSource="{Binding SelectedBlueprint.Materials}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:Material">
                                <!-- Wrap the row in a border to provide a separator line -->
                                <Border BorderBrush="#33ffffff"
                                        BorderThickness="0,0,0,1"
                                        Padding="0,4">
                                    <DockPanel Margin="0.2">
                                        
                                        <!-- TOTAL Price for this material (Quantity * UnitPrice) -->
                                        <TextBlock Text="{Binding TotalPrice, StringFormat='\{0:N2\} ISK'}"
                                                   DockPanel.Dock="Right"
                                                   Foreground="#ffb300"
                                                   FontWeight="Bold"
                                                   TextAlignment="Right"
                                                   Width="150" />

                                        <!-- Quantity -->
                                        <TextBlock Text="{Binding Quantity, StringFormat='\{0:N0\}'}"
                                                   DockPanel.Dock="Right"
                                                   Foreground="#ffb300"
                                                   FontWeight="Bold"
                                                   TextAlignment="Right" />
                                        
                                        <!-- Name -->
                                        <TextBlock Text="{Binding Name}"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                        
                                        <!-- Unit Price -->
                                        <TextBlock Text="{Binding UnitPrice, StringFormat= '(\{0:N2\}/Unit)'}"
                                                   DockPanel.Dock="Right"
                                                   Foreground="Gray"
                                                   FontSize="11"
                                                   VerticalAlignment="Center"
                                                   Margin="10,0,0,0"/>
                                    </DockPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>
                <TextBlock Text="{Binding SelectedBlueprint.TypeId, StringFormat='Type ID: {0}'}"
                           FontSize="10"
                           Foreground="Gray"
                           Margin="0,20,0,0" />
                
                <!-- Total Price -->
                <StackPanel Margin="0,15,0,0">
                    <Separator Height="1" Background="Gray" Margin="0,0,0,10" />
                    <DockPanel>
                        <TextBlock Text="Total Build Cost:" FontWeight="Bold" FontSize="16" />
                        <TextBlock Text="{Binding SelectedBlueprint.TotalBuildCost, StringFormat='\{0:N2\} ISK'}"
                                   DockPanel.Dock="Right"
                                   TextAlignment="Right"
                                   Foreground="#00ff00"
                                   FontWeight="Bold"
                                   FontSize="18" />
                    </DockPanel>
                </StackPanel>
                
                <StackPanel>
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Market Value (Jita Sell):" FontSize="12" Opacity="0.7"/>
                        <TextBlock Text="{Binding SelectedBlueprint.ProductPrice, StringFormat='\{0:N2\} ISK'}"
                                   DockPanel.Dock="Right"
                                   TextAlignment="Right"/>
                    </DockPanel>
                    
                    <!-- Profit Display -->
                    <DockPanel>
                        <TextBlock Text="Est. Profit:" FontWeight="Bold" FontSize="16"/>
                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="10">
                            <!-- Percent Margin -->
                            <TextBlock Text="{Binding SelectedBlueprint.Margin, StringFormat='({0:F1}%)'}"
                                       VerticalAlignment="Center"
                                       FontSize="12"
                                       Foreground="{Binding SelectedBlueprint.Profit, Converter={StaticResource ProfitColorConverter}}"/>
                            <!-- Cash Profit -->
                            <TextBlock Text="{Binding SelectedBlueprint.Profit, StringFormat='\{0:N2\} ISK'}"
                                       TextAlignment="Right"
                                       FontWeight="Bold"
                                       FontSize="18"
                                       Foreground="{Binding SelectedBlueprint.Profit, Converter={StaticResource ProfitColorConverter}}"/>
                        </StackPanel>
                    </DockPanel>
                </StackPanel>
            </StackPanel>
        </Border>
    </Grid>
</Window>